<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Добавить недостающие стили */
    body {
      padding: 20px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    .date-filter {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .input-field {
      width: 100%;
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
    }

    /* Обновленные стили карточек */
    .event-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      border: 1px solid #dee2e6;
      transition: all 0.2s;
    }

    .event-card:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .event-title {
      font-weight: 500;
      color: #212529;
      font-size: 15px;
      max-width: 70%;
    }

    .event-time {
      color: #495057;
      font-size: 0.9em;
      white-space: nowrap;
    }

    .event-location {
      color: #2b8a3e;
      font-size: 0.9em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .event-participants {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.85em;
    }

    .organizer-badge {
      background: #d3f9d8;
      color: #2b8a3e;
      padding: 2px 8px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
    }

    .participants-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .participant-email {
      background: #e7f5ff;
      color: #1864ab;
      padding: 2px 8px;
      border-radius: 12px;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .more-participants {
      color: #868e96;
      align-self: center;
    }

  </style>
</head>
<body>
  <div class="date-filter">
    <input type="date" id="startDate" class="input-field">
    <input type="date" id="endDate" class="input-field">
    <button onclick="loadEvents()" class="button">Поиск</button>
  </div>

  <div id="eventsList"></div>

  <script>
    function loadEvents() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      
      google.script.run
        .withSuccessHandler(renderEvents)
        .withFailureHandler(error => alert('Ошибка: ' + error.message))
        .getUpcomingMeetings(start, end);
    }

    function formatTime(isoString, timeZone) {
      if (!isoString) return '';
      const options = { 
        hour: '2-digit',
        minute: '2-digit'
      };
      return new Date(isoString)
        .toLocaleTimeString('ru-RU', {...options, timeZone});
    }    
    
    function renderEvents(events) {
      const container = document.getElementById('eventsList');
      container.innerHTML = events.map(e => `
        <div class="event-card" onclick="selectEvent('${e.id}')">
          <div class="event-time">
            ${formatTime(e.startTime, e.timeZone)} → ${formatTime(e.endTime, e.timeZone)}
          </div>
          
          ${e.location ? `
            <div class="event-location">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                <circle cx="12" cy="9" r="2.5"/>
              </svg>
              ${e.location}
            </div>
          ` : ''}

          <div class="event-participants">
            ${e.organizer ? `
              <div class="organizer-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <line x1="20" y1="8" x2="20" y2="14"></line>
                  <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                ${e.organizer}
              </div>
            ` : ''}

            <div class="participants-list">
              ${e.participants.slice(0,3).map(p => `
                <div class="participant-email">${p}</div>
              `).join('')}
              
              ${e.participants.length > 3 ? `
                <div class="more-participants">+${e.participants.length - 3}</div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function selectEvent(eventId) {
      google.script.run
        .withSuccessHandler(() => google.script.host.close())
        .selectEvent(eventId);
    }

    // Инициализация дат
    window.onload = function() {
      const now = new Date();
      const startDate = new Date(now.setDate(now.getDate() - 3)).toISOString().split('T')[0];
      const endDate = new Date(now.setDate(now.getDate() + 6)).toISOString().split('T')[0];
      
      document.getElementById('startDate').value = startDate;
      document.getElementById('endDate').value = endDate;
      loadEvents();
    };
  </script>
</body>
</html>